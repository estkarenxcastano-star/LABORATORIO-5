# LABORATORIO 5
### OBJETIVO
Identificar cambios en el balance auton√≥mico mediante an√°lisis temporal de la
variabilidad de la frecuencia card√≠aca (HRV).

# PARTE A

<img width="385" height="571" alt="image" src="https://github.com/user-attachments/assets/e1c437f6-2b18-4f31-b480-a99615fa7f83" />

Se realiz√≥ una investigaci√≥n te√≥rica, sobre los siguientes temas:

**1. Actividad simp√°tica y parasimp√°tica del sistema nervioso aut√≥nomo**


El sistema nervioso aut√≥nomo (SNA) es la parte del sistema nervioso encargada de regular de manera involuntaria funciones vitales como la frecuencia card√≠aca, la respiraci√≥n, la digesti√≥n, la actividad glandular y el di√°metro pupilar. Su funci√≥n principal es mantener la homeostasis del organismo y permitir que el cuerpo responda adecuadamente a las demandas internas y externas. El SNA se divide en dos ramas que act√∫an de forma complementaria y muchas veces opuesta: el sistema nervioso simp√°tico y el sistema nervioso parasimp√°tico.


El sistema nervioso simp√°tico est√° asociado con la respuesta de ‚Äúlucha o huida‚Äù, un conjunto de reacciones fisiol√≥gicas que se activan ante situaciones de estr√©s, peligro o aumento de la exigencia f√≠sica. Cuando se activa esta rama, el organismo se prepara para la acci√≥n: aumenta la frecuencia y la fuerza de contracci√≥n del coraz√≥n, se dilatan las pupilas y los bronquios para mejorar la entrada de luz y aire, se movilizan las reservas de glucosa para obtener energ√≠a r√°pida y se redirige el flujo sangu√≠neo hacia los m√∫sculos esquel√©ticos. Al mismo tiempo, se inhiben funciones no prioritarias como la digesti√≥n, disminuyendo la motilidad gastrointestinal y las secreciones digestivas. Tambi√©n se produce vasoconstricci√≥n en piel y v√≠sceras, sudoraci√≥n y la liberaci√≥n de adrenalina y noradrenalina desde la m√©dula suprarrenal. En este sistema, la noradrenalina es el neurotransmisor predominante en las sinapsis posganglionares, mientras que la acetilcolina participa principalmente en las sinapsis preganglionares.


Por su parte, el sistema nervioso parasimp√°tico promueve la respuesta de ‚Äúreposo y digesti√≥n‚Äù, predominante en condiciones de calma y recuperaci√≥n. Su activaci√≥n favorece funciones destinadas a conservar y restaurar la energ√≠a del organismo. Entre sus efectos se encuentran la disminuci√≥n de la frecuencia card√≠aca, la constricci√≥n pupilar, la broncoconstricci√≥n y la estimulaci√≥n de la actividad del tracto gastrointestinal, lo que incluye aumento de la motilidad, secreciones digestivas y peristaltismo. Este sistema tambi√©n estimula funciones como la salivaci√≥n, la micci√≥n, la defecaci√≥n y la actividad de gl√°ndulas lagrimales. A diferencia del simp√°tico, el neurotransmisor predominante en las sinapsis tanto preganglionares como posganglionares es la acetilcolina, que act√∫a sobre receptores nicot√≠nicos y muscar√≠nicos.


Ambos sistemas, simp√°tico y parasimp√°tico, trabajan de manera coordinada para mantener el equilibrio del organismo. Aunque sus acciones suelen ser opuestas, no act√∫an de forma aislada; m√°s bien, el estado fisiol√≥gico depende del predominio relativo de uno u otro seg√∫n las necesidades del momento. En situaci√≥n de reposo suele dominar el parasimp√°tico, mientras que en momentos de estr√©s o actividad f√≠sica predomina el simp√°tico. Esta interacci√≥n permite respuestas r√°pidas, adaptativas y eficientes, garantizando el adecuado funcionamiento de los √≥rganos y sistemas del cuerpo.

**2. Efecto de la actividad simp√°tica y parasimp√°tica en la frecuencia card√≠aca**


La frecuencia card√≠aca est√° regulada por el equilibrio entre la actividad simp√°tica y parasimp√°tica del sistema nervioso aut√≥nomo. La actividad simp√°tica aumenta la frecuencia card√≠aca mediante la liberaci√≥n de noradrenalina y adrenalina, que act√∫an sobre receptores Œ≤1 del coraz√≥n, acelerando la despolarizaci√≥n del nodo sinoauricular y mejorando la conducci√≥n el√©ctrica, lo que prepara al organismo para situaciones de estr√©s, alarma o esfuerzo f√≠sico. En contraste, la actividad parasimp√°tica, principalmente a trav√©s del nervio vago y la liberaci√≥n de acetilcolina sobre receptores muscar√≠nicos M2, disminuye la frecuencia card√≠aca al reducir la velocidad de despolarizaci√≥n del nodo SA y enlentecer la conducci√≥n en el nodo AV, predominando en condiciones de reposo y favoreciendo la conservaci√≥n de energ√≠a. As√≠, el ritmo card√≠aco final es el resultado del balance din√°mico entre ambas ramas, que ajustan el funcionamiento del coraz√≥n seg√∫n las necesidades del organismo.

**3. Variabilidad de la frecuencia card√≠aca (HRV) obtenida a partir de la se√±al electrocardiogr√°fica (ECG)**


La variabilidad de la frecuencia card√≠aca (HRV) es una medida que refleja las fluctuaciones naturales en el intervalo de tiempo entre un latido card√≠aco y el siguiente, conocidas como intervalos R-R, las cuales se obtienen a partir del an√°lisis de la se√±al electrocardiogr√°fica (ECG). Estas variaciones no son aleatorias, sino que representan la interacci√≥n din√°mica entre las ramas simp√°tica y parasimp√°tica del sistema nervioso aut√≥nomo. Para calcular la HRV, primero se identifican los picos R en el ECG ‚Äîlos puntos de mayor amplitud del complejo QRS‚Äî y se determina la duraci√≥n entre cada par de picos consecutivos; la serie de estos intervalos permite aplicar an√°lisis temporales (como SDNN o RMSSD), frecuenciales (como las bandas LF y HF) o no lineales. Una HRV elevada indica un sistema aut√≥nomo flexible y eficiente, con predominio parasimp√°tico y buena capacidad de adaptaci√≥n fisiol√≥gica, mientras que valores bajos suelen asociarse con estr√©s, fatiga, disfunci√≥n auton√≥mica o estados patol√≥gicos. En conjunto, la HRV derivada del ECG es una herramienta no invasiva, sensible y ampliamente utilizada para evaluar la regulaci√≥n auton√≥mica del coraz√≥n y el estado general del organismo.

**4. Diagrama de Poincar√© como herramienta de an√°lisis de la serie R-R.**


El diagrama de Poincar√© es una herramienta gr√°fica utilizada para analizar la variabilidad de la frecuencia card√≠aca (HRV) a partir de la serie de intervalos R-R obtenidos del electrocardiograma. Consiste en representar cada intervalo R-R en funci√≥n del siguiente, es decir, colocar cada valor  RRn+1  en el eje horizontal y el intervalo siguiente  RRn+1  en el eje vertical. Al hacerlo, se genera una nube de puntos cuya forma y dispersi√≥n permiten visualizar de manera sencilla la din√°mica del sistema nervioso aut√≥nomo. En condiciones fisiol√≥gicas normales, el gr√°fico adopta una forma elipsoidal cuyo ancho transversal, conocido como SD1, est√° relacionado con la variabilidad instant√°nea de los latidos y refleja principalmente la actividad parasimp√°tica. Por otro lado, la longitud del eje mayor, conocida como SD2, representa la variabilidad a m√°s largo plazo, influida tanto por modulaciones simp√°ticas como parasimp√°ticas. Un diagrama amplio y disperso suele asociarse con una regulaci√≥n auton√≥mica saludable y flexible, mientras que un patr√≥n estrecho, lineal o muy compacto indica una disminuci√≥n de la variabilidad, lo cual puede relacionarse con estr√©s, fatiga o disfunci√≥n auton√≥mica. Gracias a su capacidad para mostrar patrones no lineales y ofrecer una interpretaci√≥n visual r√°pida, el diagrama de Poincar√© se considera un complemento valioso para el an√°lisis tradicional de la HRV.

+ **Posteriormente se adquiri√≥ la se√±al ECG**

Se adquiri√≥ la se√±al por medio del DAQ

```python
import pandas as pd
import io

df = pd.read_csv(io.BytesIO(uploaded['Se√±al_ECG (2).txt']),
                 sep=r'\s+',
                 header=0)

df.head()
```
| t [s]   | Voltaje [V] |
|---------|--------------|
| 0.0000  | 2.334708     |
| 0.0005  | 2.528737     |
| 0.0010  | 2.202068     |
| 0.0015  | 2.168427     |
| 0.0020  | 2.459448     |

+ **Gr√°fica se√±al adquirida**

  ```python
  import matplotlib.pyplot as plt
  import numpy as np

  plt.figure(figsize=(8, 5))  # tama√±o de la figura

  plt.plot(df['t[s]'], df['voltaje[V]'], linewidth=0.5)

  plt.xlim(0, 240)            # tiempo [s]
  plt.ylim(-4, 4)             # voltaje [V]

  plt.xticks(np.arange(0, 241, 50))
  plt.yticks(np.arange(-4, 5, 1))


  plt.xlabel('Tiempo [s]')
  plt.ylabel('Voltaje [V]')
  plt.title('Se√±al ECG')

  # Cuadr√≠cula
  plt.grid(True)

  ax = plt.gca()
  ax.spines['top'].set_visible(False)
  ax.spines['right'].set_visible(False)

  plt.tight_layout()
  plt.show()
  ```
  <img width="630" height="392" alt="image" src="https://github.com/user-attachments/assets/80db840b-5d96-44af-a310-ec82b5c58c3c" />

  # PARTE B

  <img width="311" height="653" alt="image" src="https://github.com/user-attachments/assets/ffc47a48-2b6f-4ac0-addf-4711b1b2863f" />

Pre - procesamiento de la se√±al
Aplicar los filtros digitales necesarios para eliminar el ruido de la se√±al, demostrando su dise√±o.
- Dise√±ar un filtro IIR de acuerdo con los par√°metros de la se√±al,
- Obtener la ecuaci√≥n en diferencias del filtro,
- Implementar el filtro a la se√±al obtenida asumiendo par√°metros iniciales en 0.

```python
# Leer el archivo
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Leer el archivo de texto (ajusta el nombre si Colab lo muestra distinto en 'uploaded')
df = pd.read_csv("Se√±al_ECG (2).txt", sep=r"\s+", header=0)

# Columnas: tiempo y voltaje
t = df["t[s]"].values.astype(float)
x = df["voltaje[V]"].values.astype(float)

print("Muestras:", len(x))
print("Tiempo total [s]:", t[-1] - t[0])
print("Voltaje min/max:", x.min(), x.max())

plt.figure(figsize=(12,4))
plt.plot(t, x, alpha=0.7)
plt.xlabel("Tiempo [s]")
plt.ylabel("Voltaje [V]")
plt.title("ECG inicial (se√±al cruda)")
plt.grid(True)
plt.tight_layout()
plt.show()
```
**Este c√≥digo carga la se√±al ECG desde un archivo, extrae sus datos y grafica el voltaje en funci√≥n del tiempo.**
+ *Muestras: 480000*
+ *Tiempo total [s]: 239.9995*
+ *Voltaje min/max: 1.245738154976885 3.5*

<img width="952" height="312" alt="image" src="https://github.com/user-attachments/assets/d7320795-d7d5-4042-a7ab-4a0e5621fdcf" />

+ **Dise√±o Filtro IIR**
```python
# Dise√±ar el filtro IIR, pasa‚Äìbanda para ECG
# se filtra aprox. 0.5 ‚Äì 40 Hz.

from scipy.signal import butter, sosfilt

# Dise√±o del mismo filtro pero en forma SOS
sos = butter(orden, [low, high], btype="bandpass", output="sos")
print("Matriz SOS:\n", sos)

# Filtrado con condiciones iniciales = 0
ecg_filtrado = sosfilt(sos, x)

plt.figure(figsize=(12,4))
plt.plot(t, x, label="ECG inicial", alpha=0.4)
plt.plot(t, ecg_filtrado, label="ECG filtrado", linewidth=1)
plt.xlabel("Tiempo [s]")
plt.ylabel("Voltaje [V]")
plt.title("ECG antes y despu√©s del filtro IIR Butterworth 0.5‚Äì40 Hz")
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()
```
Matriz en formato SOS que contiene los coeficientes de cada secci√≥n biquad del filtro digital implementado.

| b0           | b1           | b2           | a0 | a1           | a2           |
|--------------|--------------|--------------|----|--------------|--------------|
| 1.26657730e-05 | 2.53315460e-05 | 1.26657730e-05 | 1  | -1.78354137e+00 | 7.97115047e-01 |
| 1.00000000e+00 | 2.00000000e+00 | 1.00000000e+00 | 1  | -1.89566508e+00 | 9.10625808e-01 |
| 1.00000000e+00 | -2.00000000e+00 | 1.00000000e+00 | 1  | -1.99704749e+00 | 9.97050061e-01 |
| 1.00000000e+00 | -2.00000000e+00 | 1.00000000e+00 | 1  | -1.99881745e+00 | 9.98819938e-01 |

<img width="948" height="310" alt="image" src="https://github.com/user-attachments/assets/fbf1883c-8dbd-4624-bf89-d38aaf6f8663" />

+ **Dividir la se√±al filtrada en dos segmentos de se√±al con duraci√≥n de 2 minutoscada uno**
  ```python
  # Duraci√≥n de cada segmento (2 minutos)
  dur_seg = 2 * 60  # 120 s

  mask1 = (t >= 0) & (t < dur_seg)          # 0‚Äì120 s
  mask2 = (t >= dur_seg) & (t < 2*dur_seg)  # 120‚Äì240 s

  t1 = t[mask1]
  ecg1 = ecg_filtrado[mask1]

  t2 = t[mask2]
  ecg2 = ecg_filtrado[mask2]

  print("Seg1 duraci√≥n [s]:", t1[-1] - t1[0])
  print("Seg2 duraci√≥n [s]:", t2[-1] - t2[0])

  plt.figure(figsize=(12,4))
  plt.plot(t1, ecg1)
  plt.title("Segmento 1 (0‚Äì120 s)")
  plt.xlabel("Tiempo [s]")
  plt.ylabel("Voltaje [V]")
  plt.grid(True)
  plt.tight_layout()
  plt.show()

  plt.figure(figsize=(12,4))
  plt.plot(t2, ecg2)
  plt.title("Segmento 2 (120‚Äì240 s)")
  plt.xlabel("Tiempo [s]")
  plt.ylabel("Voltaje [V]")
  plt.grid(True)
  plt.tight_layout()
  plt.show()
  ```
  + *Seg1 duraci√≥n [s]: 119.9995*
  + *Seg2 duraci√≥n [s]: 119.99950000000001*
  

  <img width="950" height="306" alt="image" src="https://github.com/user-attachments/assets/d841ea8e-12a7-4ae3-b602-8f90e6a2aee0" />

  <img width="948" height="306" alt="image" src="https://github.com/user-attachments/assets/63aa3d69-0103-4063-862c-1fccf6897bff" />

  + **Identificar los picos R en cada uno de los segmentos, calcular los intervalos R-R y obtener una nueva se√±al con dicha informaci√≥n**

    ```python
    from scipy.signal import find_peaks
    import numpy as np

    fs = 2000
    min_rr = 0.3
    dist = int(min_rr * fs)

    # ====================================
    # AJUSTE DE PROMINENCIA EN SEGMENTO 1
    # ====================================
    print("Probando prominencias para SEGMENTO 1‚Ä¶")

    prom_candidates = [
    np.std(ecg1) * 1.0,
    np.std(ecg1) * 1.5,
    np.std(ecg1) * 2.0,
    np.std(ecg1) * 2.5
    ]

    for prom in prom_candidates:
    pk, _ = find_peaks(ecg1, distance=dist, prominence=prom)
    print(f"prom={prom:.4f} ‚Üí {len(pk)} picos")

    # üëâ Despu√©s, elige el mejor. Por ahora ponemos una opci√≥n provisional:
    prom1 = np.std(ecg1) * 1.57    # AJ√öSTALO seg√∫n lo que imprima arriba

    peaks1, _ = find_peaks(ecg1, distance=dist, prominence=prom1)


    # ==============================
    # SEGMENTO 2 (esto s√≠ funcionaba)
    # ==============================
    prom2 = np.std(ecg2) * 3
    peaks2, _ = find_peaks(ecg2, distance=dist, prominence=prom2)

    print("\nPicos finales en SEGMENTO 1:", len(peaks1))
    print("Picos finales en SEGMENTO 2:", len(peaks2))
    ```

+ *Probando prominencias para SEGMENTO 1‚Ä¶*
+ *prom=0.0785 ‚Üí 282 picos*
+ *prom=0.1177 ‚Üí 257 picos*
+ *prom=0.1570 ‚Üí 195 picos*
+ *prom=0.1962 ‚Üí 108 picos*

+ *Picos finales en SEGMENTO 1: 255*
+ *Picos finales en SEGMENTO 2: 237*

```python
# ===========================================
# C√°lculo de intervalos R-R y nueva se√±al RR
# ===========================================

# Tiempos de cada pico R en cada segmento
tR1 = t1[peaks1]       # tiempos de peaks del seg1
tR2 = t2[peaks2]       # tiempos de peaks del seg2

# C√°lculo de intervalos R-R
RR1 = np.diff(tR1)     # se√±al RR del segmento 1
RR2 = np.diff(tR2)     # se√±al RR del segmento 2

# Tiempo asociado a cada intervalo R-R
tRR1 = tR1[1:]         # empieza en el segundo pico
tRR2 = tR2[1:]

print("Segmento 1:")
print("  RR1 =", RR1[:10], " ...")
print("  N√∫mero de intervalos:", len(RR1))

print("\nSegmento 2:")
print("  RR2 =", RR2[:10], " ...")
print("  N√∫mero de intervalos:", len(RR2))
```
+ **Segmento 1:**
  RR1 = [1.1595 0.326  0.327  0.5105 0.355  0.3625 0.435  0.324  0.4655 0.5095]  ...
  N√∫mero de intervalos: 254

+ **Segmento 2:**
  RR2 = [0.7655 0.508  0.314  0.47   0.6    0.404  0.6035 0.404  0.6975 0.464 ]  ...
  N√∫mero de intervalos: 236

  + **Gr√°fica de la nueva se√±al**
```python
# ================================
# Gr√°fica de la nueva se√±al R-R
# ================================

plt.figure(figsize=(10,4))
plt.plot(tRR1, RR1, '.-', label='RR Segmento 1')
plt.xlabel("Tiempo [s]")
plt.ylabel("Intervalo R-R [s]")
plt.title("Nueva se√±al de intervalos R-R (Segmento 1)")
plt.grid(True)
plt.legend()
plt.show()

plt.figure(figsize=(10,4))
plt.plot(tRR2, RR2, '.-', label='RR Segmento 2')
plt.xlabel("Tiempo [s]")
plt.ylabel("Intervalo R-R [s]")
plt.title("Nueva se√±al de intervalos R-R (Segmento 2)")
plt.grid(True)
plt.legend()
plt.show()
```

<img width="677" height="317" alt="image" src="https://github.com/user-attachments/assets/1dd31dc4-5625-4f76-bca1-6ec08bfd147c" />


<img width="677" height="310" alt="image" src="https://github.com/user-attachments/assets/0f00c805-ed97-4fc2-b543-144c96f93880" />

+ **Comparar los valores de los par√°metros b√°sicos de la HRV en el dominio del tiempo, como la media de los intervalos R-R y su desviaci√≥n est√°ndar, entre ambos segmentos de se√±al ECG**

```python
# ================================
# Estad√≠sticas de intervalos RR
# ================================

import numpy as np

def stats_RR(RR):
    if len(RR) == 0:
        return np.nan, np.nan, np.nan
    RR_mean = np.mean(RR)
    RR_sd   = np.std(RR, ddof=1)
    HR      = 60 / RR_mean
    return RR_mean, RR_sd, HR

RR1_mean, RR1_sd, HR1 = stats_RR(RR1)
RR2_mean, RR2_sd, HR2 = stats_RR(RR2)

print("===== SEGMENTO 1 (Reposo) =====")
print("RR medio:", RR1_mean)
print("SDNN:", RR1_sd)  #Representa cu√°nta variabilidad hay en los intervalos R‚ÄìR.
print("FC media (lpm):", HR1)

print("\n===== SEGMENTO 2 (Lectura) =====")
print("RR medio:", RR2_mean)
print("SDNN:", RR2_sd)
print("FC media (lpm):", HR2)
```
===== SEGMENTO 1 (Reposo) =====
RR medio: 0.47212007874015743
SDNN: 0.14237386189807577
FC media (lpm): 127.0863127874348

===== SEGMENTO 2 (Lectura) =====
RR medio: 0.506375
SDNN: 0.16822658937379914
FC media (lpm): 118.48926191063934

El siguiente c√≥digo organiza los valores calculados de HRV en un DataFrame para mostrar una tabla comparativa entre los segmentos de reposo y lectura.

```python
import pandas as pd

# Tus valores calculados
data = {
    "Par√°metro": ["RR medio (s)", "SDNN (s)", "FC media (lpm)"],
    "Segmento 1 (Reposo)": [0.472, 0.142, 127.1],
    "Segmento 2 (Lectura)": [0.506, 0.168, 118.5]
}

# Crear tabla
tabla_hfv = pd.DataFrame(data)

# Mostrar tabla
tabla_hfv
```

| Par√°metro        | Segmento 1 (Reposo) | Segmento 2 (Lectura) |
|------------------|---------------------|------------------------|
| RR medio (s)     | 0.472               | 0.506                  |
| SDNN (s)         | 0.142               | 0.168                  |
| FC media (lpm)   | 127.100             | 118.500                |

El an√°lisis comparativo de los par√°metros b√°sicos de la variabilidad de la frecuencia card√≠aca (HRV) en el dominio del tiempo permiti√≥ identificar diferencias significativas entre los dos segmentos de la se√±al ECG evaluados. En el primer segmento, correspondiente a la condici√≥n de reposo, se obtuvo un intervalo R‚ÄìR medio menor y una desviaci√≥n est√°ndar (SDNN) relativamente reducida, en conjunto con una frecuencia card√≠aca m√°s elevada. Este comportamiento es indicativo de una menor variabilidad del ritmo cardiaco y sugiere una mayor influencia del sistema nervioso simp√°tico, asociado a estados de activaci√≥n fisiol√≥gica o demanda metab√≥lica incrementada.


Por otro lado, en el segundo segmento ‚Äîregistrado durante la lectura‚Äî se observ√≥ un aumento tanto en el intervalo R‚ÄìR medio como en la desviaci√≥n est√°ndar de los intervalos, acompa√±ado de una disminuci√≥n en la frecuencia card√≠aca. Este patr√≥n refleja un incremento en la variabilidad cardiaca y es coherente con una mayor participaci√≥n del sistema nervioso parasimp√°tico, el cual tiende a disminuir la frecuencia cardiaca y a favorecer una regulaci√≥n m√°s flexible del ritmo auton√≥mico.


Los cambios observados entre ambos segmentos evidencian una modificaci√≥n clara en el balance auton√≥mico. Mientras que el estado de reposo present√≥ una predominancia simp√°tica relativa, la actividad de lectura mostr√≥ un predominio parasimp√°tico y un aumento de la HRV. Estas diferencias reflejan la capacidad del sistema cardiovascular para adaptarse din√°micamente a distintas condiciones fisiol√≥gicas y cognitivas.


    






